<div th:fragment="gauge" class="container">
    <div>
        <div class="gauge-container">
            <div class="gauge"></div>
            <div class="gauge"></div>
            <div class="gauge"></div>
        </div>
    </div>

    <!-- 필수 라이브러리: jQuery, DevExtreme, WebSocket -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn3.devexpress.com/jslib/22.2.6/js/dx.all.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <script>
        $(function () {
            // GaugeChart 클래스 정의
            class GaugeChart {
                constructor(el, { initialValue, higherValue, title, subtitle }) {
                    this._el = el;
                    this._initialValue = initialValue;
                    this._higherValue = higherValue;
                    this._title = title;
                    this._subtitle = subtitle;
                }

                _buildConfig() {
                    return {
                        rangeContainer: {
                            backgroundColor: '#ffffff',
                            width: 30,
                            ranges: [
                                {startValue: 78.0, endValue: 79.5, color: '#ff8228'},
                                {startValue: 79.5, endValue: 81.0, color: '#4166f5'},
                                {startValue: 81.0, endValue: 82.0, color: '#ffc228'},
                                {startValue: 82.0, endValue: 82.5, color: '#ff8228'}
                            ]
                        },
                        valueIndicator: {color: '#000'},
                        geometry: {startAngle: 200, endAngle: 340},
                        scale: {
                            startValue: 78.0,
                            endValue: this._higherValue,
                            orientation: 'outside',
                            tick: {visible: true, length: 20, width: 1, color: '#000'},
                            minorTick: {visible: true, length: 5, width: 1, color: '#000'},
                            label: {font: {color: '#4c5156', size: 12}}
                        },
                        title: {
                            verticalAlignment: 'bottom',
                            text: this._title,
                            subtitle: {
                                text: this._subtitle,
                                font: {weight: 600, size: 20}
                            }
                        },
                        value: this._initialValue
                    };
                }

                init() {
                    this._gauge = $(this._el)
                        .dxCircularGauge(this._buildConfig())
                        .dxCircularGauge('instance');
                    return this;
                }

                update(value) {
                    this._gauge.option('value', value);
                    this._gauge.option('title.text', `${value.toFixed(1)} ºC`);
                }
            }

            // 게이지 A, B, C 인스턴스 생성
            const gaugeInstances = [];
            $('.gauge').each((i, el) => {
                const letter = String.fromCharCode(65 + i); // A, B, C
                const gauge = new GaugeChart(el, {
                    initialValue: 78.0,
                    higherValue: 82.5,
                    title: '78.0 ºC',
                    subtitle: `금형온도 ${letter}`
                }).init();
                gaugeInstances.push(gauge);
            });

            // WebSocket 연결 및 구독
            const stompClient = Stomp.over(new SockJS('/ws'));
            stompClient.connect({}, () => {
                const names = ['NORMAL', 'BUMP', 'HALF']; // A, B, C 매핑
                names.forEach((name, i) => {
                    stompClient.subscribe(`/topic/temperature/${name}`, message => {
                        const value = parseFloat(message.body);
                        gaugeInstances[i].update(value);
                    });
                });
            });
        });
    </script>
</div>
