<html layout:decorate="~{layout}" lang="ko" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<div class="container mb-5" layout:fragment="content">
    <h2 class="my-4">오늘의 달성률</h2>
    <div class="row mb-5">
        <div class="col-12 col-md-6 col-lg-6">
            <h5 class="text-center mt-3">
                오늘의 목표 수량: <span th:text="${targetQuantity}">0</span>개
            </h5>
            <div class="tassei">
                <canvas id="achievementRate"></canvas>
            </div>
        </div>

        <div class="col-12 col-md-6 col-lg-6 ">
            <div class="mt-3"> </div>
            <div class="row g-3 h-100">
                <div class="col">
                    <div class="card shadow-sm h-100">
                        <div class="card-body d-flex flex-column justify-content-center text-center">
                            <h6 class="text-muted mb-2">✅ 달성 수량</h6>
                            <h4 class="mb-0" th:text="${okCount} + '개'">0개</h4>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card shadow-sm h-100">
                        <div class="card-body d-flex flex-column justify-content-center text-center">
                            <h6 class="text-muted mb-2">📈 달성률</h6>
                            <h4 class="mb-0" th:text="${achievementRate} + '%'">0%</h4>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card shadow-sm h-100">
                        <div class="card-body d-flex flex-column justify-content-center text-center">
                            <h6 class="text-muted mb-2">📉 남은 수량</h6>
                            <h4 class="mb-0" th:text="${targetQuantity - okCount} + '개'">0개</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- 금형온도 -->
    <div class="my-4">
        <h2 class="mb-4">금형 온도 실시간 모니터링</h2>
        <div class="container pe-0 ps-0">
            <div class="row justify-content-between gx-4 gy-4">
                <div class="col-12 col-lg-4">
                    <h5> NORMAL</h5>
                    <div class="d-flex flex-column align-items-center">
                        <div class="gauge mb-3"></div>
                        <div class="chart-wrapper w-100">
                            <canvas id="chartA"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-4">
                    <h5> BUMP</h5>
                    <div class="d-flex flex-column align-items-center">
                        <div class="gauge mb-3"></div>
                        <div class="chart-wrapper w-100">
                            <canvas id="chartB"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-4">
                    <h5>HALF</h5>
                    <div class="d-flex flex-column align-items-center">
                        <div class="gauge mb-3"></div>
                        <div class="chart-wrapper w-100">
                            <canvas id="chartC"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-12 my-lg-2">
        <h2 class="my-4">생산량 통계</h2>
        <canvas id="monitoringChart2" class="mt-3" height="215"></canvas>
    </div>

    <h2 class="mb-4">제품별 생산 현황</h2>
    <div class="row">
        <div class="col-12 col-lg-4">
            <canvas class="my-2" id="chart-NORMAL" width="200" height="200"></canvas>
        </div>
        <div class="col-12 col-lg-4">
            <canvas class="my-2" id="chart-BUMP" width="200" height="200"></canvas>
        </div>
        <div class="col-12 col-lg-4">
            <canvas class="my-2" id="chart-HALF" width="200" height="200"></canvas>
        </div>
    </div>

    <h2 class="my-4">재고 건수</h2>
    <canvas id="materialChart" height="100"></canvas>
    <button id="showToastBtn" class="btn btn-refoam position-fixed bottom-0 end-0 m-4" style="z-index: 1100;">
        📋 리포트 보기
    </button>
    <div class="position-fixed bottom-0 mb-5 end-0 p-3" style="z-index: 1100">
        <div id="aiReportToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto">📋 AI 리포트</strong>
                <small class="text-muted">방금 전</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                <span style="white-space: pre-line; margin-bottom: 0;" id="toastBody">AI 분석 리포트 불러오는 중...</span>
            </div>
        </div>
    </div>
    <!-- 스크립트 로딩 순서 중요 -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        // jQuery 중복 로딩 체크
        if (typeof jQuery === 'undefined') {
            document.write('<script src="https://code.jquery.com/jquery-3.6.0.min.js"><\/script>');
        }
    </script>

    <!-- 2. Chart.js 관련 (레이아웃에서 로딩되므로 조건부 로딩) -->
    <script>
        // Chart.js 중복 로딩 체크
        if (typeof Chart === 'undefined') {
            document.write('<script src="https://cdn.jsdelivr.net/npm/chart.js"><\/script>');
        }
    </script>

    <!-- 3. Chart.js 플러그인들 -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

    <!-- 4. DevExtreme 계기판 -->
    <link rel="stylesheet" href="https://cdn3.devexpress.com/jslib/22.2.6/css/dx.light.css">
    <script src="https://cdn3.devexpress.com/jslib/22.2.6/js/dx.all.js"></script>

    <!-- 5. WebSocket 관련 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <!-- 6. 메인 스크립트 -->
    <script th:inline="javascript">
        // Chart.js CDN 대체 로딩 로직
        (function() {
            const cdnList = [
                'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js',
                'https://unpkg.com/chart.js@3.9.1/dist/chart.min.js',
                'https://cdn.jsdelivr.net/npm/chart.js'
            ];

            let loaded = false;
            let currentIndex = 0;

            function loadNextCDN() {
                if (loaded || currentIndex >= cdnList.length) return;

                const script = document.createElement('script');
                script.src = cdnList[currentIndex];
                script.onload = function() {
                    loaded = true;
                    console.log('Chart.js 로드 성공:', cdnList[currentIndex]);
                };
                script.onerror = function() {
                    console.log('Chart.js 로드 실패:', cdnList[currentIndex]);
                    currentIndex++;
                    loadNextCDN();
                };
                document.head.appendChild(script);
            }

            loadNextCDN();
        })();
    </script>

    <!-- 3. DevExtreme (게이지용) -->
    <link rel="stylesheet" href="https://cdn3.devexpress.com/jslib/22.2.6/css/dx.light.css">
    <script src="https://cdn3.devexpress.com/jslib/22.2.6/js/dx.all.js"></script>

    <!-- 4. WebSocket 관련 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <!-- 5. 수정된 메인 스크립트 -->
    <script th:inline="javascript">
        // 전역 변수
        let temperatureCharts = [];
        let gaugeInstances = [];
        let stompClient = null;
        let isConnected = false;

        // 모든 라이브러리 로드 대기 함수
        function waitForLibraries() {
            return new Promise((resolve) => {
                const checkLibraries = () => {
                    const jqueryReady = typeof $ !== 'undefined';
                    const chartReady = typeof Chart !== 'undefined';
                    const devExtremeReady = typeof DevExpress !== 'undefined';
                    const sockjsReady = typeof SockJS !== 'undefined';
                    const stompReady = typeof Stomp !== 'undefined';

                    if (jqueryReady && chartReady && devExtremeReady && sockjsReady && stompReady) {
                        resolve();
                    } else {
                        console.log('라이브러리 로딩 대기 중...', {
                            jquery: jqueryReady,
                            chart: chartReady,
                            devExtreme: devExtremeReady,
                            sockjs: sockjsReady,
                            stomp: stompReady
                        });
                        setTimeout(checkLibraries, 500);
                    }
                };
                checkLibraries();
            });
        }

        // DOM 준비 후 실행
        $(document).ready(function() {
            console.log('DOM 로드 완료');

            waitForLibraries().then(() => {
                console.log('모든 라이브러리 로드 완료');
                initializeAll();
            }).catch(error => {
                console.error('라이브러리 로딩 실패:', error);
            });
        });

        function initializeAll() {
            try {
                initializeBasicCharts();
                initializeTemperatureCharts();
                initializeGauges();
                initializeWebSocketConnection();
                initializeToast();
                initializeProductChart();
            } catch (error) {
                console.error('초기화 오류:', error);
            }
        }

        // 기본 차트들 (재고, 생산량, 달성률)
        function initializeBasicCharts() {
            console.log('기본 차트 초기화 시작');

            // 서버 데이터 가져오기
            const materialLabels = /*[[${materialLabels}]]*/ [];
            const materialData = /*[[${materialData}]]*/ [];
            const materialColors = /*[[${materialColors}]]*/ [];
            const stats = /*[[${productionMonitorings}]]*/ [];
            const rate = /*[[${achievementRate}]]*/ 75;
            const target = /*[[${targetRate}]]*/ 90;
            const isAchieved = rate >= target;
            const barColor = isAchieved ? "rgba(0, 200, 100, 0.7)" : "rgba(63, 0, 255, 0.7)";

            // 차트 데이터 준비
            const labels = stats.map((s) => s.date);
            const ok = stats.map((s) => s.okCount);
            const err = stats.map((s) => s.errCount);
            const order = stats.map((s) => s.orderCount);

            // 재고 차트
            const ctx2 = document.getElementById("materialChart");
            if (ctx2) {
                new Chart(ctx2.getContext("2d"), {
                    type: "bar",
                    data: {
                        labels: materialLabels,
                        datasets: [{
                            label: "원재료별 수량",
                            data: materialData,
                            backgroundColor: materialColors,
                            borderColor: [
                                'rgb(113,237,237)',
                                'rgb(147,147,147)',
                                'rgb(28,28,28)',
                                'rgb(32,121,255)',
                                'rgb(255,70,136)',
                                'rgb(113,237,237)'
                            ],
                            borderWidth: 2,
                        }],
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: true },
                            x: { title: { display: true, text: "원재료" } },
                        },
                    },
                });
            }

            // 생산량 통계 차트
            const monitoringCtx = document.getElementById("monitoringChart2");
            if (monitoringCtx) {
                new Chart(monitoringCtx, {
                    type: "bar",
                    data: {
                        labels: labels,
                        datasets: [
                            // 여기부터는 라인 차트 (랜덤값으로 그려놓음 => 필요하면 추가)
                            {
                                label: 'NORMAL',
                                data: [19, 17, 18, 16, 17, 12],
                                type: 'line',
                                borderColor: 'rgb(154,103,255)',
                                backgroundColor: 'rgb(156,156,255)',
                                yAxisID: 'y',
                            },
                            {
                                label: 'BUMP',
                                data: [18, 15, 17, 16, 15, 18],
                                type: 'line',
                                borderColor: 'rgb(147,147,147)',
                                backgroundColor: 'rgb(173,177,190)',
                                yAxisID: 'y',

                            },
                            {
                                label: 'HALF',
                                data: [14, 13, 16, 15, 16, 14],
                                type: 'line',
                                borderColor: 'rgb(255,99,132)',
                                backgroundColor: 'rgb(255,171,189)',
                                yAxisID: 'y',

                            },//여기까지
                            {
                                label: "총 주문 건수",
                                data: order,
                                borderColor: '#0051b6',
                                backgroundColor: "#a7cffd",
                            },
                            {
                                label: "완제품 수",
                                data: ok,
                                borderColor: '#369189',
                                backgroundColor: "#8ef6da",
                            },
                            {
                                label: "불량품 수",
                                data: err,
                                borderColor: '#ff5c6c',
                                backgroundColor: "#ffbab7",
                            },
                        ],
                    },
                    options: {
                        elements: {
                            bar: {
                                borderWidth: 2,
                            }
                        },
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: "생산량 통계",
                            },
                            legend: {
                                position: "top",
                            },
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: "공정 날짜",
                                },
                                ticks: {
                                    autoSkip: true,
                                    maxRotation: 45,
                                },
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: "수량",
                                },
                            },
                        },
                    },
                });
            }

            // 달성률 차트 (ChartDataLabels 플러그인 없이)
            const achievementCtx = document.getElementById("achievementRate");
            if (achievementCtx) {
                new Chart(achievementCtx, {
                    type: "bar",
                    data: {
                        labels: ["목표 달성률"],
                        datasets: [{
                            label: "오늘의 달성률",
                            data: [rate],
                            backgroundColor: barColor,
                            borderWidth: 0,
                        }],
                    },
                    options: {
                        maintainAspectRatio: false,
                        indexAxis: "y",
                        scales: {
                            x: {
                                max: 100,
                                beginAtZero: true,
                                ticks: {
                                    callback: function (value) {
                                        return value + "%";
                                    },
                                },
                                title: {
                                    display: true,
                                    text: "(목표: " + target + "%)",
                                },
                            },
                            y: {
                                grid: { display: false },
                                ticks: { display: false },
                            },
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: "top",
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return "현재 달성률: " + context.raw + "%";
                                    },
                                },
                            },
                        },
                    },
                });
            }
            console.log('기본 차트 초기화 완료');
        }

        // 온도 라인 차트 초기화 (WebSocket 데이터만 받음)
        function initializeTemperatureCharts() {
            console.log('온도 차트 초기화 시작');

            // double MIN_MOLD_TEMPERATURE = 80.462;
            // double MAX_MOLD_TEMPERATURE = 81.883;

            const HIGH_THRESHOLD = 81.4;
            const LOW_THRESHOLD = 80.8;
            const MAX_POINTS = 50;
            const names = ['NORMAL', 'BUMP', 'HALF'];
            const letters = ['A', 'B', 'C'];
            const colors = ['red', 'orange', 'blue'];

            temperatureCharts = letters.map((letter, i) => {
                const canvas = document.getElementById(`chart${letter}`);
                if (!canvas) {
                    console.warn(`Canvas chart${letter} not found`);
                    return null;
                }

                const ctx = canvas.getContext('2d');
                const chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: names[i],
                            data: [],
                            borderWidth: 2,
                            fill: false,
                            borderColor: 'blue',
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            tension: 0.1,
                            pointBackgroundColor: function(context) {
                                const dataIndex = context.dataIndex;
                                const value = context.dataset.data[dataIndex];
                                if (typeof value === 'number') {
                                    if (value >= HIGH_THRESHOLD) return 'red';
                                    if (value <= LOW_THRESHOLD) return 'green';
                                }
                                return 'blue';
                            },
                            borderColor: function(context) {
                                if (context.type === 'dataset') {
                                    return 'blue';
                                }
                                const dataIndex = context.dataIndex;
                                const value = context.dataset.data[dataIndex];
                                if (typeof value === 'number') {
                                    if (value >= HIGH_THRESHOLD) return 'red';
                                    if (value <= LOW_THRESHOLD) return 'green';
                                }
                                return 'blue';
                            }
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                title: { display: true, text: '시간' },
                                ticks: { maxTicksLimit: 8 }
                            },
                            y: {
                                min: 80,
                                max: 82,
                                title: { display: true, text: '온도 (℃)' },
                            }
                        },
                        plugins: {
                            legend: { display: true, position: 'top' },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        return context[0].label;
                                    },
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}℃`;
                                    }
                                }
                            }
                        }
                    }
                });
                Promise.all(
                    names.map((name, i) =>
                        fetch(`/api/temperature/${name}`)
                            .then(res => res.json())
                            .then(data => {
                                const formatted = Array.isArray(data)
                                    ? data.map(d => ({ x: new Date(d.time), y: d.value }))
                                    : [{ x: new Date(data.time), y: data.value }];
                                charts[i].data.datasets[0].data = formatted;
                                charts[i].update();
                            })
                    )
                ).then(() => {
                    // 3. WebSocket 연결은 과거 데이터가 모두 로딩된 이후에 시작
                    const stompClient = Stomp.over(new SockJS('/ws'));
                    stompClient.connect({}, () => {
                        names.forEach((name, i) => {
                            stompClient.subscribe(`/topic/temperature/${name}`, message => {
                                const y = parseFloat(message.body);
                                const x = new Date();
                                const ds = charts[i].data.datasets[0];
                                ds.data.push({ x, y });
                                if (ds.data.length > MAX_POINTS) ds.data.shift();
                                charts[i].update('none');
                            });
                        });
                    });
                });

                return chart;
            }).filter(chart => chart !== null);
        }



        // 게이지 차트 초기화
        function initializeGauges() {
            console.log('게이지 초기화 시작');

            class GaugeChart {
                constructor(el, { initialValue, higherValue, title, subtitle }) {
                    this._el = el;
                    this._initialValue = initialValue;
                    this._higherValue = higherValue;
                    this._title = title;
                    this._subtitle = subtitle;
                }

                _buildConfig() {
                    return {
                        rangeContainer: {
                            backgroundColor: '#ffffff',
                            width: 30,
                            ranges: [
                                {startValue: 78.0, endValue: 79.5, color: '#ff8228'},
                                {startValue: 79.5, endValue: 81.0, color: '#4166f5'},
                                {startValue: 81.0, endValue: 82.0, color: '#ffc228'},
                                {startValue: 82.0, endValue: 82.5, color: '#ff8228'}
                            ]
                        },
                        valueIndicator: {color: '#000'},
                        geometry: {startAngle: 200, endAngle: 340},
                        scale: {
                            startValue: 78.0,
                            endValue: this._higherValue,
                            orientation: 'outside',
                            tick: {visible: true, length: 20, width: 1, color: '#000'},
                            minorTick: {visible: true, length: 5, width: 1, color: '#000'},
                            label: {font: {color: '#4c5156', size: 12}}
                        },
                        title: {
                            verticalAlignment: 'bottom',
                            text: this._title,
                            subtitle: {
                                text: this._subtitle,
                                font: {weight: 600, size: 20}
                            }
                        },
                        value: this._initialValue
                    };
                }

                init() {
                    try {
                        this._gauge = $(this._el)
                            .dxCircularGauge(this._buildConfig())
                            .dxCircularGauge('instance');
                        console.log('게이지 생성 성공:', this._subtitle);
                        return this;
                    } catch (error) {
                        console.error('게이지 생성 실패:', this._subtitle, error);
                        return null;
                    }
                }

                update(value) {
                    if (this._gauge) {
                        this._gauge.option('value', value);
                        this._gauge.option('title.text', `${value.toFixed(1)} ºC`);
                    }
                }
            }

            // 게이지 인스턴스 생성
            gaugeInstances = [];
            $('.gauge').each((i, el) => {
                const letter = String.fromCharCode(65 + i); // A, B, C
                const gauge = new GaugeChart(el, {
                    initialValue: 78.0,
                    higherValue: 82.5,
                    title: '78.0 ºC',
                }).init();

                if (gauge) {
                    gaugeInstances.push(gauge);
                }
            });

            console.log(`게이지 ${gaugeInstances.length}개 초기화 완료`);
        }

        // WebSocket 연결 (실제 데이터만 받음)
        function initializeWebSocketConnection() {
            console.log('WebSocket 연결 시작');

            if (typeof SockJS === 'undefined' || typeof Stomp === 'undefined') {
                console.error('WebSocket 라이브러리가 로드되지 않았습니다');
                return;
            }

            try {
                stompClient = Stomp.over(new SockJS('/ws'));
                stompClient.connect({}, function(frame) {
                    console.log('WebSocket 연결 성공:', frame);
                    isConnected = true;

                    const names = ['NORMAL', 'BUMP', 'HALF'];
                    names.forEach((name, i) => {
                        // 온도 라인 차트 구독
                        stompClient.subscribe(`/topic/temperature/${name}`, function(message) {
                            const value = parseFloat(message.body);
                            const timeStr = new Date().toLocaleTimeString();

                            console.log(`온도 데이터 수신 ${name}:`, value);

                            // 라인 차트 업데이트
                            if (temperatureCharts[i]) {
                                const chart = temperatureCharts[i];
                                chart.data.labels.push(timeStr);
                                chart.data.datasets[0].data.push(value);

                                // 최대 포인트 수 제한
                                if (chart.data.labels.length > 50) {
                                    chart.data.labels.shift();
                                    chart.data.datasets[0].data.shift();
                                }

                                chart.update('none');
                            }

                            // 게이지 업데이트
                            if (gaugeInstances[i]) {
                                gaugeInstances[i].update(value);
                            }
                        });
                    });

                }, function(error) {
                    console.error('WebSocket 연결 실패:', error);
                    isConnected = false;
                });

            } catch (error) {
                console.error('WebSocket 초기화 오류:', error);
            }
        }

        // Toast 초기화
        function initializeToast() {
            const btn = document.getElementById("showToastBtn");
            const toastEl = document.getElementById("aiReportToast");
            const toastBody = document.getElementById("toastBody");

            if (btn && toastEl && toastBody && typeof bootstrap !== 'undefined') {
                const toast = new bootstrap.Toast(toastEl, { delay: 10000 });

                btn.addEventListener("click", function () {
                    toastBody.textContent = "AI 리포트를 불러오는 중입니다...";
                    toast.show();

                    fetch("/ai-summary")
                        .then((res) => res.text())
                        .then((text) => {
                            toastBody.textContent = text;
                            toast.show();
                        })
                        .catch((err) => {
                            toastBody.textContent = "❌ 리포트 요청 실패";
                            toast.show();
                        });
                });
            }
        }
        // 제품별 파이 차트용 전역 변수
        const chartMap = {};
        const productStatMap = JSON.parse(localStorage.getItem("productStatMap")) || {};
        const productNames = ['NORMAL', 'BUMP', 'HALF'];

        function initializeProductChart() {
            console.log('제품별 파이 차트 초기화 시작');

            // 차트 초기화
            productNames.forEach(name => {
                const ctx = document.getElementById(`chart-${name}`);
                if (!ctx) {
                    console.warn(`chart-${name} 캔버스를 찾을 수 없습니다.`);
                    return;
                }

                chartMap[name] = new Chart(ctx.getContext("2d"), {
                    type: 'pie',
                    data: {
                        labels: ['정상 제품 수', '불량 제품 수'],
                        datasets: [{
                            data: [0, 0],
                            borderColor: ['#0051b6','rgb(255,99,132)'],
                            backgroundColor: ['#a6cdfb', '#fdb9b6'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: `${name} 제품 생산 비율`
                            },
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return `${context.label}: ${context.parsed}개`;
                                    }
                                }
                            }
                        }
                    }
                });
            });

            // 초기 데이터 로딩
            fetch('/api/production/by-product')
                .then(res => res.json())
                .then(data => {
                    data.forEach(({ productName, okCount, errorCount, timestamp }) => {
                        updateProductChart(productName, okCount, errorCount, timestamp);
                    });
                }).catch(err => {
                console.error("초기 제품 데이터 불러오기 실패:", err);
            });

            // WebSocket 연결 및 구독
            if (typeof Stomp !== 'undefined' && typeof SockJS !== 'undefined') {
                const stomp = Stomp.over(new SockJS("/ws"));
                stomp.connect({}, () => {
                    stomp.subscribe("/topic/product-count", message => {
                        const { productName, okCount, errorCount, timestamp } = JSON.parse(message.body);
                        updateProductChart(productName, okCount, errorCount, timestamp);
                    });

                    // localStorage에 저장된 이전 값 복원
                    for (const [productName, { okCount, errorCount, timestamp }] of Object.entries(productStatMap)) {
                        updateProductChart(productName, okCount, errorCount, timestamp);
                    }
                });
            } else {
                console.warn("WebSocket 라이브러리가 로드되지 않아 제품 차트 WebSocket은 비활성화됩니다.");
            }

            console.log('제품별 파이 차트 초기화 완료');
        }

        // 차트 업데이트 함수
        function updateProductChart(productName, okCount, errorCount, timestamp) {
            const date = new Date(timestamp);
            const today = new Date();
            if (
                date.getFullYear() !== today.getFullYear() ||
                date.getMonth() !== today.getMonth() ||
                date.getDate() !== today.getDate()
            ) return;

            productStatMap[productName] = { okCount, errorCount, timestamp };
            localStorage.setItem("productStatMap", JSON.stringify(productStatMap));

            const chart = chartMap[productName];
            if (!chart) return;

            chart.data.datasets[0].data = [okCount, errorCount];
            chart.update();
        }

        // 연결 상태 체크 함수 (디버깅용)
        function checkConnectionStatus() {
            console.log('연결 상태:', {
                webSocketConnected: isConnected,
                temperatureChartsCount: temperatureCharts.length,
                gaugeCount: gaugeInstances.length
            });
        }

        // 전역 함수로 노출 (디버깅용)
        window.checkConnectionStatus = checkConnectionStatus;
    </script>
</div>
</html>